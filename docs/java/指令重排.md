# 指令重排

## WHY?
为了优化性能, 需要指令重排

## WHO？
CPU本身， 内存读写缓存区，编译器都可能引起指令重排
### CPU,　指令级并行（Instruction-Level Parallelism， ILP）

### 内存,　读写缓冲区
对单一CPU 可见, 
处理器对内存的读 / 写操作的执行顺序，不一定与内存实际发生的读 / 写操作顺序一致！

目的： 减少对内存总线的占用

### 编译器
编译器也会进行

## HOW？
### 内存屏障
java 编译器在生成指令序列的适当位置会插入[[内存屏障]]指令来禁止特定类型的处理器重排序

## 限制指令重排 的原因
为了程序员能理解，提供强内存模型，又需要禁止部分重排。

### 语义
#### as-if-serial： 单线程，无数据依赖关系下
as-if-serial 语义保证单线程内程序的执行结果不被改变，无论怎么重排. 

编译器,处理器 不会对存在 **数据依赖关系**的操作做重排序

#### happens-before: 前后操作可见性
多线程 无同步的情况下， 各自重排序后，同时 由于[[可见性]] 会产生 不可预测 的结果

[[happens-before]] 描述前一个操作对后一个的可见性
happens-before 关系保证**正确同步**的多线程程序的执行结果不被改变。

