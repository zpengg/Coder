# 堆
## 分代
die young，live long。
缩短 STW 时间

 - 新生代
 - 老年代
 - 永久代\元空间 

## 结构
jmap -heap 进程号可以查看

|    Minor    |  |   Major      |
-------------------------------------
| JDK 7
| Eden  |from |to|   Old        |   Perm  |
-------------------------------------
| JDK 8+
| Eden  |from |to|   Old        |  metaspace(native) 
| Young (-Xmn)   |   Old        | 
|           heap  (-Xms -Xmx)   |

## 配置
### 堆空间
-Xmx 用来表示堆的起始内存，等价于 -XX:InitialHeapSize 默认 MAX/64
-Xms 用来表示堆的最大内存，等价于 -XX:MaxHeapSize 默认 MAX/4
设置相等，清理完堆区后**不需要重新分隔**，计算堆的大小

### 空间划分
–XX:NewRatio 配置new/old 默认1：2
–XX:SurvivorRatio 配置eden/survivor,默认 8：1：1
JDK8 默认开启 -XX:+UseAdaptiveSizePolicy  自适应,
依据： GC过程中统计的GC时间、吞吐量、内存占用量

## 新生代
### Eden 
new 对象较小 放 eden
eden 快满 触发 [[MinorGC]]

### Survivor *2  (from/to, s0/s1)
eden s0标记复制 到 to Survivor，
-XX:MaxTenuringThreshold 到老年代的年龄阈值

### TLAB（Eden区开辟的线程私有区域）
[[TLAB]] 线程私有缓存区域 减少竞争

## 老年代
### 老年代阈值
-XX:PetenureSizeThreshold 大对象直接到老年代

提前： 如果Survivor空间中相同年龄的所有对象的大小总和大于Survivor的一半，年龄大于或等于该年龄的对象就可以直接进入老年代

## 堆外对象
### 逃逸分析 栈上分配
[[逃逸分析]] 栈上分配 或者 标量替换（存CPU寄存器）

## 运行时常量池 1.7+
[[运行时常量池]]从 永久代 移动到了堆中

## 回收
### 分类
针对 HotSpot VM 的实现，它里面的 GC 按照回收区域又分为两大类：
部分收集（Partial GC），整堆收集（Full  GC） 
 - 部分收集：不是完整收集整个 Java 堆的垃圾收集。
    - 新生代收集（Minor GC/Young GC）：只是新生代的垃圾收集 
    - 老年代收集（Major GC/Old GC）：只是老年代的垃圾收集
        目前，只有 CMS GC 会有单独收集老年代的行为 
        很多时候 Major GC 会和 Full GC  混合使用，需要具体分辨是老年代回收还是整堆回收
    - 混合收集（Mixed GC）：收集整个新生代以及部分老年代的垃圾收集
        目前只有 G1 GC 会有这种行为 
 - 整堆收集（Full GC）：收集整个 Java 堆和方法区的垃圾 

 major GC 俗称， 一般指 old Gc

## 查看回收
jstat -gc -t 4235 1s



### FULL GC


1、每次晋升到老年代的对象平均大小>老年代剩余空间

2、MinorGC后存活的对象 超过了 老年代剩余空间

3、永久代空间不足

避免Perm Gen占满造成Full GC现象，可采用的方法为增大Perm Gen空间或转为使用CMS GC

5、CMS GC异常

promotion failed:MinorGC时，survivor空间放不下，对象只能放入老年代，而老年代也放不下造成

concurrent mode failure:GC时，同时有对象要放入老年代，而老年代空间不足造成

6、堆内存分配很大的对象
[[垃圾回收器]]