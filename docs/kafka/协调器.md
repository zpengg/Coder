# 协调器
辅助 消费者 [[再均衡]]

## 参与者
[[控制器]]下的
消费者协调器 ConsumerCoordinator
组协调器 GroupCoordinator

## 旧版
zookeeper watcher
/consumers/<group>/ids 
/brokers/ids
整个消费组都调整。不必要

### 问题 
#### 羊群效应
大量通知 性能低
#### 脑裂
每个消费者与zookeeper 通信时 获取的集群信息不一样


## 协调器工作过程
 - FindCoordinator 
 - JOIN group
 - SYNC group
 - HEARTBEAT --> 下一躺

### FindCoordinator 
找到groupCoordinator 所在的 broker 并与之通信

### JOIN group
#### 选举消费组leader
没有就先到先得 
leader退出则元数据直接获取 第一个

#### 选举分区分配策略
每个消费者都可以设置自己分区分配策略
共同投票给 groupCoordinator 决定

### SYNC group
leader 计票后， 通过 groupCoordinator 转发同步 分区分配方案**结果**

### HEARTBEAT
OffsetFetchRequest  确定消费位置 （ Kafka 的 __consumer_offset）
判断消费者存活 否则 再均衡